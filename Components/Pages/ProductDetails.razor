@page "/product-details/{ProductId:int}"
@rendermode InteractiveServer
@inherits BasePage

@inject DBService DB
@inject NavigationManager Nav

<PageTitle>Produkt @ProductId</PageTitle>

<div class="container py-4">

    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Indlæser produktdetaljer…</p>
        </div>
    }
    else if (product is null)
    {
        <div class="alert alert-danger text-center">
            <h4 class="alert-heading">Produkt ikke fundet</h4>
            <p>Der findes ikke noget produkt med ID <strong>@ProductId</strong> i databasen.</p>
            <button class="btn btn-outline-secondary" @onclick="NavigateHome">
                Tilbage til forsiden
            </button>
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col">
                <h2>Produktdetaljer: <span class="text-primary">@product.Name</span></h2>
                <p class="text-muted">Produkt-ID: @product.Id</p>
            </div>
            <div class="col-auto">
                @if (isOwner)
                {
                    <button class="btn btn-warning me-2" @onclick="ToggleEditMode">
                        @if (editMode)
                        {
                            <span>Annullér redigering</span>
                        }
                        else
                        {
                            <span>Rediger produkt</span>
                        }
                    </button>
                }
                <button class="btn btn-outline-secondary" @onclick="NavigateHome">
                    Tilbage
                </button>
            </div>
        </div>

        @* ------------------------------------------- *@
        @* LÆSE-KUN VISNING *@
        @* ------------------------------------------- *@
        @if (!editMode)
        {
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title mb-3">@product.Name</h5>

                            @* Vis billedet, hvis det findes *@
                            @if (!string.IsNullOrWhiteSpace(product.Image))
                            {
                                <div class="text-center mb-3">
                                    <img src="@product.Image"
                                         alt="Billede af @product.Name"
                                         class="img-fluid rounded"
                                         style="max-height: 300px; object-fit: contain;" />
                                </div>
                            }

                            <p class="card-text"><strong>Beskrivelse:</strong></p>
                            <p>
                                @(string.IsNullOrWhiteSpace(product.Description)
                                    ? (MarkupString)"<em>Ingen beskrivelse er angivet.</em>"
                                    : product.Description)
                            </p>
                            <hr />
                            <p><strong>Pris:</strong> @string.Format("{0:C}", product.Price)</p>
                            <p>
                                <strong>Farve:</strong>
                                @(string.IsNullOrWhiteSpace(product.Color) ? "—" : product.Color)
                            </p>
                            <p>
                                <strong>Størrelse:</strong>
                                @(string.IsNullOrWhiteSpace(product.Size) ? "—" : product.Size)
                            </p>
                            <p>
                                <strong>Antal:</strong> @product.Quantity
                                @if (product.Used)
                                {
                                    <span class="badge bg-secondary ms-2">Brugt</span>
                                }
                            </p>
                            <hr />
                            <p><strong>Mærke:</strong> @product.BrandName</p>
                            <p><strong>Kategori:</strong> @product.CategoryName</p>
                            <p>
                                <strong>Sælger:</strong>
                                @(string.IsNullOrWhiteSpace(product.UserName) ? "—" : product.UserName)
                            </p>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Yderligere info</h5>
                            <p class="card-text">
                                Her kan du vise logs, analyser eller kundeanmeldelser.
                            </p>
                            <p class="text-muted small">[f.eks. relaterede varer, brugerfeedback osv.]</p>
                        </div>
                    </div>
                </div>
            </div>
        }

        @* ------------------------------------------- *@
        @* REDIGERINGSFORMULAR *@
        @* ------------------------------------------- *@
        @if (editMode && isOwner)
        {
            <div class="card mt-4 shadow-sm">
                <div class="card-body">
                    <h4 class="card-title mb-3">Redigér produkt</h4>
                    <EditForm Model="editProduct" OnValidSubmit="HandleValidSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Navn</label>
                                <InputText class="form-control" @bind-Value="editProduct.Name" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Pris</label>
                                <InputNumber class="form-control" @bind-Value="editProduct.Price" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Beskrivelse</label>
                            <InputTextArea class="form-control" rows="3" @bind-Value="editProduct.Description" />
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Farve</label>
                                <InputText class="form-control" @bind-Value="editProduct.Color" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Størrelse</label>
                                <InputText class="form-control" @bind-Value="editProduct.Size" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Antal</label>
                                <InputNumber class="form-control" @bind-Value="editProduct.Quantity" />
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            <InputCheckbox class="form-check-input" @bind-Value="editProduct.Used" />
                            <label class="form-check-label">Brugt?</label>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Mærke</label>
                                <InputSelect class="form-select" @bind-Value="editProduct.BrandId">
                                    <option value="">-- vælg mærke --</option>
                                    @foreach (var b in brands)
                                    {
                                        <option value="@b.Id">@b.Name</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Kategori</label>
                                <InputSelect class="form-select" @bind-Value="editProduct.CategoryId">
                                    <option value="">-- vælg kategori --</option>
                                    @foreach (var c in categories)
                                    {
                                        <option value="@c.Id">@c.Name</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary me-2">Gem ændringer</button>
                            <button type="button" class="btn btn-outline-secondary" @onclick="CancelEdit">
                                Annuller
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        }

        @* ------------------------------------------- *@
        @* GEM-RESULTAT Meddelelser *@
        @* ------------------------------------------- *@
        @if (saveSuccess)
        {
            <div class="alert alert-success mt-4" role="alert">
                <strong>Succes!</strong> Produktet er blevet opdateret.
            </div>
        }
        @if (saveFailure)
        {
            <div class="alert alert-danger mt-4" role="alert">
                <strong>Ups!</strong> Noget gik galt. Prøv venligst igen.
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public int ProductId { get; set; }

    private Products? product;
    private Products editProduct = new();
    private bool isOwner = false;
    private bool editMode = false;
    private bool isLoading = true;

    private bool saveSuccess = false;
    private bool saveFailure = false;

    private List<Brand> categories = new();
    private List<Category> brands = new();

    protected override async Task OnInitializedAsync()
    {
        // Indlæs produktet inkl. brand/category/user-navne
        product = await DB.GetProductByIdAsync(ProductId);
        if (product is null)
        {
            isLoading = false;
            return;
        }

        // Tjek ejerskab
        if (Auth.IsAuthenticated && Auth.CurrentUser != null)
        {
            isOwner = (product.UserId == Auth.CurrentUser.Id);
        }

        // Kopiér til editProduct
        editProduct = new Products
            {
                Id = product.Id,
                Name = product.Name,
                Description = product.Description,
                Price = product.Price,
                Color = product.Color,
                Size = product.Size,
                Quantity = product.Quantity,
                Used = product.Used,
                BrandId = product.BrandId,
                CategoryId = product.CategoryId,
                UserId = product.UserId,
                Image = product.Image
            };

        // Indlæs dropdown-data
        categories = await DB.GetAllBrandsAsync();
        brands = await DB.GetAllCategoriesAsync();

        isLoading = false;
    }

    private void ToggleEditMode()
    {
        saveSuccess = false;
        saveFailure = false;
        editMode = !editMode;

        if (editMode && product != null)
        {
            editProduct = new Products
                {
                    Id = product.Id,
                    Name = product.Name,
                    Description = product.Description,
                    Price = product.Price,
                    Color = product.Color,
                    Size = product.Size,
                    Quantity = product.Quantity,
                    Used = product.Used,
                    BrandId = product.BrandId,
                    CategoryId = product.CategoryId,
                    UserId = product.UserId,
                    Image = product.Image
                };
        }
    }

    private void CancelEdit()
    {
        if (product != null)
        {
            editProduct = new Products
                {
                    Id = product.Id,
                    Name = product.Name,
                    Description = product.Description,
                    Price = product.Price,
                    Color = product.Color,
                    Size = product.Size,
                    Quantity = product.Quantity,
                    Used = product.Used,
                    BrandId = product.BrandId,
                    CategoryId = product.CategoryId,
                    UserId = product.UserId,
                    Image = product.Image
                };
        }
        saveSuccess = false;
        saveFailure = false;
        editMode = false;
    }

    private async Task HandleValidSubmit()
    {
        saveSuccess = false;
        saveFailure = false;

        // Gem ændringer (billedet forbliver uændret)
        var ok = await DB.UpdateProductAsync(editProduct);
        if (ok)
        {
            // Efter en succesfuld update, bevarer vi de samme joined‐navne
            product = new Products
                {
                    Id = editProduct.Id,
                    Name = editProduct.Name,
                    Description = editProduct.Description,
                    Price = editProduct.Price,
                    Color = editProduct.Color,
                    Size = editProduct.Size,
                    Quantity = editProduct.Quantity,
                    Used = editProduct.Used,
                    BrandId = editProduct.BrandId,
                    CategoryId = editProduct.CategoryId,
                    UserId = editProduct.UserId,
                    Image = editProduct.Image,
                    BrandName = product.BrandName,
                    CategoryName = product.CategoryName,
                    UserName = product.UserName
                };

            saveSuccess = true;
            editMode = false;
        }
        else
        {
            saveFailure = true;
        }
    }

    private void NavigateHome()
    {
        Nav.NavigateTo("/");
    }
}
